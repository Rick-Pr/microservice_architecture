name: Docker Compose CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Docker Compose
      run: |
        mkdir -p ~/.docker/cli-plugins/
        curl -SL https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
        chmod +x ~/.docker/cli-plugins/docker-compose
        docker compose version

    - name: Lint Docker Compose file
      run: |
        docker compose config

    - name: Build Docker Compose services
      run: |
        docker compose build --no-cache

    - name: Start services
      run: |
        docker compose up -d

    - name: Check service status
      run: |
        docker compose ps
        docker compose logs

    - name: Run health checks
      run: |
        # Проверка статуса сервисов через Docker
        for service in $(docker compose ps --services); do
          echo "Checking service: $service"
          # Проверка статуса контейнера
          docker compose ps $service | grep -q "Up" || exit 1
        done

    - name: Detailed service logs
      if: failure()
      run: |
        # Вывод подробных логов в случае неудачи
        docker compose logs

    - name: Stop and clean up
      if: always()
      run: |
        docker compose down
        docker compose rm -f
